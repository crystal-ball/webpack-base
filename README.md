<h1 align="center">üîÆ Crystal ball webpack base configs</h1>

<p align="center">
  <a href="https://www.npmjs.com/package/@crystal-ball/webpack-base">
    <img src="https://img.shields.io/npm/v/@crystal-ball/webpack-base.svg?style=flat-square" alt="current version">
  </a>
  <a href="https://travis-ci.com/crystal-ball/webpack-base">
    <img src="https://travis-ci.com/crystal-ball/webpack-base.svg?branch=master" alt="Build">
  </a>
  <a href="https://github.com/prettier/prettier" target="_blank" rel="noopener noreferrer">
    <img src="https://img.shields.io/badge/styled_with-prettier-ff69b4.svg" alt="Prettier">
  </a>
  <a href="https://github.com/semantic-release/semantic-release" target="_blank" rel="noopener noreferrer">
    <img src="https://img.shields.io/badge/%20%20%F0%9F%93%A6%F0%9F%9A%80-semantic--release-e10079.svg" alt="managed by semantic release">
  </a>
  <img src="https://img.shields.io/badge/%20%20%F0%9F%A6%84%F0%9F%8C%88-made%20with%20love-ce068b.svg" alt="made with love" />
</p>

This package creates a base webpack configuration for modern React projects. The
exported function expects an options object with the build environment. An
optional paths object can be used to customize build behavior.

## Installation

```bash
npm i -D @crystal-ball/webpack-base
```

## Usage

```javascript
// webpack.config.js
const webpackBase = require('@crystal-ball/webpack-base')

module.exports = env => {
  const baseConfigs = webpackBase(/* { path, serve } */)

  /*
   * Handle non-standard, advanced project customization by directly updating the
   * generated base configs.
   */
  // eg: baseConfigs.bail = false

  return baseConfigs
}
```

The environment variable should be declared in the webpack build script with
`--env`, eg:

```json
{
  "build": "NODE_ENV=production webpack --env=production"
}
```

### Configuring

The base configurations generated by the package can be customized per project
by passing a configuration object.

#### Configurations

```javascript
// The top level overrides allow specifying the build env, dev server
// customizations and default path overrides
const configs = {
  env,
  devServer,
  paths,
}
```

#### Path overrides

```javascript
const paths = {
  /**
   * Application entry point(s) used for the webpack entry. Override to add
   * additional entries like Babel polyfills, multiple application entries, etc.
   * @type {File|Array<File>}
   * @default appIndexJs
   */
  appEntry,
  /**
   * Application index file used as the default entry in the `appEntry`.
   * @type {File}
   * @default src/index.js
   */
  appIndexJs,
  /**
   * Application public static files directory. This directory is copied to the
   * build without manipulation by the `CopyWebpackPlugin` and provides an
   * escape hatch to include assets in a build without importing them in the
   * application source.
   * @type {Directory}
   * @default public
   */
  appPublic,
  /**
   * Application source files directory. The directory is added to the webpack
   * `resolve.modules` config to allow using imports relative to the source
   * directory.
   * @type {Directory}
   * @default src
   */
  appSrc,
  /**
   * Directories/files that will be loaded && transpiled with Babel using the
   * `babel-loader`.
   * @type {Array<Directory|File>}
   * @default ['src']
   */
  babelLoaderInclude,
  /**
   * Path to the `index.html` template used by `HtmlWebpackPlugin` to generate
   * the build `index.html` with injected build assets.
   * @type {File}
   * @default public/index.html
   */
  htmlTemplate,
  /**
   * Directories/files that will be loaded && sprited using the
   * `SVGSymbolSprite` system.
   * @type {Array<Directory|File>}
   * @default [src/media/icons]
   */
  iconsSpriteLoaderInclude,
  /**
   * Filename template used for build JS output files. Production builds include
   * the `[chunkhash]` to enable long term caching.
   * @type {string}
   * @default static/js/[name].[production?chunkhash].js
   */
  outputFilename,
  /**
   * Directory that build assets are emitted to.
   * @type {Directory}
   * @default dist
   */
  outputPath,
  /**
   * The prefix appended to every URL created by the runtime or loaders. This
   * enables serving an application with a CDN or server subdirectory.
   * @type {string}
   * @default /
   */
  publicPath,
  /**
   * Directories included in the SASS resolver. Resources in these directories
   * will be available using relative imports. Useful for importing shared SASS
   * resources inside component SASS definitions.
   * @type {Array<Directory>}
   * @default ['src/styles']
   */
  sassIncludePaths,
}
```

## Project structure

Build defaults use the following directory structure:

```
project
‚îú‚îÄ / public
‚îÇ  ‚îú‚îÄ  index.html
‚îÇ  ‚îî‚îÄ  favicon.ico
‚îú‚îÄ / src
‚îÇ  ‚îî‚îÄ / api
‚îÇ  ‚îî‚îÄ / components
‚îÇ  ‚îî‚îÄ / dux
‚îÇ  ‚îî‚îÄ / lib
‚îÇ  ‚îî‚îÄ / media
‚îÇ  ‚îî‚îÄ / styles
‚îÇ  ‚îî‚îÄ  index.js
‚îú‚îÄ  .babelrc
‚îî‚îÄ  webpack.config.js
```

## webpack Resolution

The build configures the following module resolutions for convenient shorthand
imports of common project directories.

| Module        | Usage                                                                       |
| ------------- | --------------------------------------------------------------------------- |
| `/src`        | Allows relative imports from the src directory, useful for shared utilities |
| `/src/styles` | Allows importing style variables directly from any SASS partial             |

## Environment variables

The following environment variables are injected by the build:

| Constant                  | Usage                                                                                   |
| ------------------------- | --------------------------------------------------------------------------------------- |
| `process.env.NODE_ENV`    | Defaults to match NODE_ENV, used by Babili to strip code in prod builds                 |
| `process.env.DEBUG`       | Defaults to false, can be used for adding detailed logging in dev environment           |
| `process.env.PUBLIC_PATH` | Set to `publicPath` configuration, useful for importing media and configuring CDN paths |

## üê≥ Using with Docker

In order to use the project inside of a Docker container, the following ports
must be exposed: `3000` and `3001`. Include a `DOCKER` environment variable when
starting the server to set the host and ports:

```
DOCKER=true npx webpack-serve
```

## Testing

Development and testing of the repository use a Docker workflow to ensure that
the generated configs work with the packages required and the minimum version of
Node supported. The `/test-app` directory includes a complete test application.

Unit tests are run with Jest and use snapshots to validate the generated configs
for development and production environments.

1.  Start the docker container: `npm run container` (The image/container will be
    created and started)
2.  Start the webpack server for Docker envs: `npm run start:docker`

## Features

TODO...

- [`webpack-serve-overlay`][overlay] provides an error overlay on compilation
  error.

## Contributing üòÉ

All contributions are greatly appreciated üëçüéâ. To contribute please:

- Review the repo [Code of Conduct](./CODE_OF_CONDUCT.md), it is not just for
  show!
- Review the [Contributing Guide](./CONTRIBUTING.md) for a helpful code overview
  and repository pull request process details.

## Node version support

Node version running inside Atom's Electron instance is support target to ensure
users of ESLint import plugin are able to parse these webpack configs.

## Roadmap

- [ ] Investigate usage of [profile][] in builds
- [ ] Investigate including [Bundle Buddy][bundle] plugin

<!-- Links -->

[overlay]: https://github.com/G-Rath/webpack-serve-overlay
[profile]: https://webpack.js.org/configuration/other-options/#profile
[bundle]: https://github.com/samccone/bundle-buddy
